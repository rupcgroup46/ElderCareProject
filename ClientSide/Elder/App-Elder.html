<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <!------ Include the above in your HEAD tag ---------->
    <style>
        .contact-form {
            background: #fff;
            margin-top: 10%;
            margin-bottom: 5%;
            /*width: 70%;*/
        }

            .contact-form .form-control {
                border-radius: 1rem;
            }

        .contact-image {
            text-align: center;
        }

            .contact-image img {
                border-radius: 6rem;
                width: 11%;
                margin-top: -3%;
                transform: rotate(29deg);
            }

        .contact-form form {
            padding: 14%;
            padding-top: 0px;
        }

            .contact-form form .row {
                margin-bottom: -7%;
            }

        .contact-form h3 {
            margin-bottom: 8%;
            margin-top: -10%;
            text-align: center;
            color: #0062cc;
        }

        .contact-form .btnContact {
            width: 50%;
            border: none;
            border-radius: 1rem;
            padding: 1.5%;
            background: #dc3545;
            font-weight: 600;
            color: #fff;
            cursor: pointer;
        }

        .btnContactSubmit {
            width: 50%;
            border-radius: 1rem;
            padding: 1.5%;
            color: #fff;
            background-color: #0062cc;
            border: none;
            cursor: pointer;
        }

        td {
            width: 100px
        }

        div > img {
            width: 100px;
            height: 100px;
        }

        input.form-control {
            text-align: right;
        }

        .col-md-6 {
            text-align: center;
        }

        .selectType {
            border: solid black 1px;
            border-radius: 10px;
            margin: 5px;
        }

        .selected {
          border: solid rgb(135, 239, 135) 1px;
          background-color: rgb(135, 239, 135);
        }
    </style>
    <script>

      var selectedDivs = []; //array of helptypes 
      var nextElderID = 0; //Elders' ID counter

      $(document).ready(function() {

        //Get cities list from the server
        fetch('https://localhost:7241/api/Associations/cities', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            },
          })
            .then(response => response.json())
            .then(data => {
              document.getElementById("cities").innerHTML = "";
              for (let i = 0; i < data.length; i++) {
                str = "<option value='"+data[i]+"'>"
                document.getElementById("cities").innerHTML += str;
              }
            })
            .catch(error => console.error(error));

        //Get elders data from the server
        fetch('https://localhost:7241/api/Elders', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            },
          })
            .then(response => response.json())
            .then(data => {
              nextElderID = data[data.length-1].id; //generate next elder ID
            })
            .catch(error => console.error(error));
        
        //display or not the helper's fields    
        document.getElementById("helperCheck").addEventListener("click", checkClickFunc);
        function checkClickFunc() {
          if (document.getElementById("helperCheck").checked == true)
            document.getElementById("extraDetails").style.display="block";
          else
            document.getElementById("extraDetails").style.display="none";
        }
  
        //form submit
        $("#helpRequest").submit(function(){

          //setup fields
          const name = $("#nameInput").val();
          const phoneNum = $("#phoneInput").val();
          const city = $("#cityInput").val();
          var relativeName = $("#relativeNameInput").val();
          if (relativeName == "") {
            relativeName = "null";
          }
          var relativeNum = $("#relativeNumInput").val();
          if (relativeNum == "") {  
            relativeNum = "null";
          }
          var today = new Date();
          var helpTypesStr = selectedDivs.join(",");

          //Create new elder object
          var newElder = {
            Name:name,
            PhoneNum:phoneNum,
            City:city,
            HelpTypes:helpTypesStr,
            RelativeName:relativeName,
            RelativeNum:relativeNum
          }
          console.log("New Elder: ",newElder);

          //POST the new elder object
          fetch('https://localhost:7241/api/Elders', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(newElder)
          })
            .then(response => response.json())
            .then(data => console.log("Elder Was Added: ",data))
            .catch(error => console.error("Error: ",error));
         
          //each selected help type opens a new application and searches for relevant associations
          for (let i = 0; i < selectedDivs.length; i++) {

            let chosenAssociations = [];
            var chosenAssociationsStr = "";

            //GET associations
            fetch(`https://localhost:7241/api/Associations/helpType/${selectedDivs[i]}/city/${city}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json'
              },
            })
              .then(response => response.json())
              .then(associations => {
                console.log("all relevant associations: ", associations);
                associations.sort((a, b) => a.helpingRatio - b.helpingRatio); //sort the array by their helping ratio
                console.log("sorted relevant associations: ", associations);
                if (associations.length < 5) {
                  for (let i = 0; i < associations.length; i++) {
                    chosenAssociations.push(associations[i]);
                  }
                } else {
                  for (let i = 0; i < 5; i++) {
                    chosenAssociations.push(associations[i]);
                  }
                }
                console.log("chosen: ", chosenAssociations);
                chosenAssociationsStr = chosenAssociations.map(item => item.id).join(',');

                return chosenAssociationsStr;
              })
              .then(chosenAssociationsStr => {

                let status = "null";
                if (chosenAssociationsStr == ""){
                  status = "לא נמצאה עמותה";
                }
                
                //Create new application object
                var newApplication = {
                  Status: status,
                  HelpType: selectedDivs[i],
                  City: city,
                  StartDate: today,
                  UpdateDate: new Date(null),
                  EndDate: new Date(null),
                  ElderID: nextElderID+1,
                  HandlingAssociationID: 0,
                  SentAssociationsID: chosenAssociationsStr
                }
                console.log("New Application: ", newApplication);

                //POST new application object
                return fetch('https://localhost:7241/api/Applications', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(newApplication)
                })
              })
              .then(response => response.json())
              .then(data => console.log("Application Was Added: ", data))
              .catch(error => console.error(error));
          }

          return false;
        })

        //allows multiple selection of help types
        var divs = document.querySelectorAll('.selectType');
        divs.forEach(function (div) {
          div.addEventListener('click', toggleDivBorder);
        });
        function toggleDivBorder() {
          var id = this.id;
          var index = selectedDivs.indexOf(id);
          if (index !== -1) {
            selectedDivs.splice(index, 1);
          } else {
            selectedDivs.push(id);
          }
          this.classList.toggle('selected');
          console.log(selectedDivs);
        }

      });



      //audio for input fields
      window.onload = function () {
        // const nameInput = document.getElementById("nameInput");
        // const phoneInput = document.getElementById("phoneInput");
        // const cityInput = document.getElementById("cityInput");
        // const nameAudio = document.getElementById("nameAudio");
        // const phoneAudio = document.getElementById("phoneAudio");
        // const cityAudio = document.getElementById("cityAudio");

        // nameInput.addEventListener("click", function () {
        //     nameAudio.play();
        // });
        // phoneInput.addEventListener("click", function () {
        //     phoneAudio.play();
        // });
        // cityInput.addEventListener("click", function () {
        //     cityAudio.play();
        // });
      }

    </script>
</head>
<body>
    <div class="container contact-form">
        <form id="helpRequest">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <table>
                            <tr>
                                <p>:אנא בחר את סוגי הסיוע המבוקשים</p>
                            </tr>
                            <tr>
                                <td>
                                    <div id="ביגוד" class="selectType">
                                        <img src="/ClientSide/images/clothes icon.png" />
                                        <p>ביגוד</p>
                                    </div>
                                </td>
                                <td>
                                    <div id="מזון" class="selectType">
                                        <img src="/ClientSide/images/food icon.webp" />
                                        <p>מזון</p>
                                    </div>
                                </td>
                                <td>
                                    <div id="סיעוד" class="selectType">
                                        <img src="/ClientSide/images/nursing icon.png" />
                                        <p>סיעוד</p>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div id="תמיכה" class="selectType">
                                        <img src="/ClientSide/images/support icon.webp" />
                                        <p>תמיכה</p>
                                    </div>
                                </td>
                                <td>
                                    <div id="ייעוץ" class="selectType">
                                        <img src="/ClientSide/images/consultation icon.png" />
                                        <p>ייעוץ</p>
                                    </div>
                                </td>
                                <td>
                                    <div id="מרכז יום" class="selectType">
                                        <img src="/ClientSide/images/day care icon.png" />
                                        <p>מרכזי יום</p>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <p>:אנא מלא את פרטי מבקש הסיוע</p>
                    <div class="form-group">
                        <input id="nameInput" type="text" name="txtName" class="form-control" placeholder="* שם מלא" value="" />
                        <audio id="nameAudio">
                            <source src="" type="audio/mp4" /> <!--Add audio-->
                        </audio>
                    </div>
                    <div class="form-group">
                        <input id="phoneInput" type="text" name="txtEmail" class="form-control" placeholder="* מספר טלפון" value="" />
                        <audio id="phoneAudio">
                            <source src="" type="audio/mp4" /> <!--Add audio-->
                        </audio>
                    </div>
                    <div class="form-group">
                        <input id="cityInput" type="text" list="cities" name="txtPhone" class="form-control" placeholder="* עיר מגורים" value="" />
                        <datalist id="cities">
                       </datalist>
                        <audio id="cityAudio">
                            <source src="" type="audio/mp4" /> <!--Add audio-->
                        </audio>
                    </div>
                    <div class="form-group" style="display: flex;justify-content: center; align-content: center;">
                      <p style="margin-right:10px;margin-top:12px;">איני מבקש הסיוע</p>
                      <input id="helperCheck" type="checkbox" name="checkboxRelative">
                    </div>
                    <div id="extraDetails" style="display:none;">
                      <p>:אנא מלא בנוסף את פרטיך</p>
                      <div class="form-group">
                        <input id="relativeNameInput" type="text" name="txtName" class="form-control" placeholder="* שם מלא" value="" />
                      </div>
                      <div class="form-group">
                        <input id="relativeNumInput" type="text" name="txtEmail" class="form-control" placeholder="* מספר טלפון" value="" />
                      </div>
                    </div>
                    <div class="form-group">
                      <input type="submit" name="btnSubmit" class="btnContact" value="שלח פנייה" />
                    </div>
                </div>
            </div>
        </form>
    </div>
</body>
</html>